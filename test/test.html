<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Message </title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css"> -->


  <style>
  .online {
    border-left: 5px solid green;
  }
  .offline{
    border-left: 5px solid grey;
  }
  .online.btn-group>.btn:first-child,.offline.btn-group>.btn:first-child{
    border-top-left-radius :0;
    border-bottom-left-radius :0;
  }
  </style>
</head>
<body>
  <div class="container">
    <h2>Message Test</h2>
    <p></p>
    <hr>
    <h4>Basic</h4>
    <div class="form-inline" >
      <div class="form-group">
        <label for="">peerId: </label>
        <input type="text" id="sender" class="form-control">
      </div>
      <div class="form-group">
        <label for="">watchingPeer: </label>
        <input type="text " id="watchingPeer" class="form-control">
      </div>
      <button id="new" class="btn btn-default"> new Client </button>
      <div class="btn-group">
        <button id="open" class="btn btn-default"> open </button>
        <button id="close" class="btn btn-warning"> close </button>
      </div>

      <span id="connect-status" class="text-primary">not connected</span>
      <div class="btn-group">
        <button id="addwatch" class="btn btn-default"> watch </button>
        <button id="removewatch" class="btn btn-default"> unwatch </button>
      </div>

    </div>
    <hr>
    <h4>Peer & Room</h4>
    <ul class="nav nav-tabs" role="tablist">
      <li class="active"><a href="#peer-container" role="tab" data-toggle="tab" >Peer</a></li>
      <li><a href="#room-container" role="tab" data-toggle="tab">Room</a></li>

    </ul>
    <div class="tab-content">
      <div id="peer-container" class="tab-pane active" >
        <h5>WatchingPeers </h5>
        <div id="allwatcher">
        </div>
        <h5>Message to <span class="text-primary" id="to-peer-id"></span></h5>
        <div  class="form-inline">
          <div class="form-group">
            <input type="text" class="form-control" id="msg">
          </div>
          <button class="btn btn-default" id="sendbtn">send</button>
        </div>

        <h5>getPeerStatus</h5>
        <div class="form-inline">
          <div class="form-group">
            <input type="text" class="form-control" id="querypeer">
          </div>
          <button class="btn btn-default" id="getstatus">getStatus</button>
          <span id="peeronline"></span>
        </div>
      </div>


      <div  id="room-container" class="tab-pane " >
        <div class="row">
          <div class="col-md-6">
            <h5>Rooms</h5>
            <div id="allroom" class="panel-group">

            </div>
          </div>
          <div class="col-md-6">
            <h5>Join or Create room</h5>
            <div class="form-inline">
              <div class="form-group">
                <input type="text" class="form-control" id="roomid">
                <button class="btn btn-default" id="joinroom">join</button>
              </div>

            </div>
            <h5>Invite To Join Room</h5>
            <div class="form-inline">
              <div class="form-group">
                <input type="text" class="form-control" id="inviteroomtxt">
                <button class="btn btn-default" id="inviteroom">invite</button>
              </div>
            </div>
            <h5>Room Message</h5>
            <div class="form-inline">
              <div class="form-group">
                <input type="text" class="form-control" id="msgroom"> <button class="btn btn-default" id="sendroom">send</button>
              </div>
            </div>
          </div>
        </div>



      </div>
    </div>


    <hr>
    <div class="row">
      <div class="col-md-6">


      </div>

    </div>
    <div class="row">
      <div class="col-md-6">
        <h4>Message Sent</h4>
        <div id="msgsent">

        </div>
      </div>

      <div class="col-md-6">
        <h4>Message Receive</h4>
        <div id="msgreceive">

        </div>
      </div>
    </div>



  </div>



<!-- <div class="btn-group offline" id="peer-@peerId@">
  <button type="button" class="btn btn-default">@peerId@</button>
  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
    <span class="caret"></span>
    <span class="sr-only">Toggle Dropdown</span>
  </button>
  <ul class="dropdown-menu" role="menu">
    <li><a onclick="setSendTo('@peerId@')">chat</a></li>
    <li><a onclick="chat.removeWatchingPeer('@peerId@')">removeWatchingPeer</a></li>
  </ul>
</div> -->
<script type="tpl" id="watcher-tpl">
<button type="button" class="btn btn-default" id="peer-@peerId@" onclick="setSendTo('@peerId@')">@peerId@</button>
</script>

<script type="tpl" id="room-tpl">


<div class="panel panel-default room" id="room-container-@roomId@" data-room-id="@roomId@">
   <div class="panel-heading">
     <h4 class="panel-title">
       <a data-toggle="collapse" data-parent="#allroom" href="#room-body-@roomId@" onclick="setCurrentRoom('@roomId@')">
         @roomId@
       </a>
       <button class="btn btn-default btn-sm leave" >leave</button>
     </h4>
   </div>
   <div id="room-body-@roomId@" class="panel-collapse collapse">
     <div class="panel-body">

       <div class="members">
       </div>
     </div>
   </div>
 </div>

</script>

<script type="tpl" id="room-member-tpl">
<div class="btn-group room-member" id="room-member-@peerId@"  data-room-member-id="@peerId@" >
  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
    @peerId@ <span class="caret"></span>
  </button>
  <ul class="dropdown-menu" role="menu">
    <li><a  class="kick">Kick</a></li>

  </ul>
</div>
</script>


<script src="https://code.jquery.com/jquery-2.1.1.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script src="promise-1.0.0.min.js"></script>
<script src="../lib/chat.js"></script>
<script src="https://cn.avoscloud.com/scripts/lib/av-0.4.1.min.js"></script>
<script>
  var appid = '9zcwm6xjbg3iajmky2xpef9wfxjwatqte1my06xdd83k26nc';

  var peerId = $('#sender').val() || 'testuser'+Math.random();
  var toPeerId;
  // var watchingPeer = $('#watchingPeer').val().split(',');
  var chat;


  //用于 Room 用户获取，chat本身不依赖 AV
  AV.initialize(appid,'ei9xtnhuh22yxfgigur6edc8b29ma19rwgajappxjgr9bj6d');

  // ---------------- 基本初始化 打开关闭 ----------------
  $('#new').click(function(){
    peerId = $('#sender').val();
    chat = new WebClient({
      appId: appid,
      peerId: $('#sender').val() || 'testuser'+Math.random(),
      watchingPeer: $('#watchingPeer').val().split(',')
      // auth: auth
    });

    chat.on('close', function(){
      alert('connection closed')
      $('#connect-status').text('not connected');
      $('.online').removeClass('online').addClass('offline');
    });
    //chat 相关监听
    chat.on('message',function(data){
      $('#msgreceive').append(JSON.stringify(data));
      $('#msgreceive').append('<br>');
      // console.log(data);
    });
    chat.on('online', function(peers){
      for(var i=0;i<peers.length;i++){
        $('#peer-'+peers[i]).removeClass('offline');
        $('#peer-'+peers[i]).addClass('online');
      }
    });
    chat.on('offline', function(peers){
      for(var i=0;i<peers.length;i++){
        $('#peer-'+peers[i]).removeClass('online');
        $('#peer-'+peers[i]).addClass('offline');
      }
    });
    //room 相关监听
    chat.on('membersJoined',function(data){
      if(data.peerId == peerId){

      }
      data.roomPeerIds.forEach(function(id){
        $('#room-container-'+data.roomId+ ' .members').append($('#room-member-tpl').html().replace(/@peerId@/g,id));
      });

      // console.log(data)
    });

    chat.on('joined',function(data){
      if($('#allroom .room').length==0){
        roomId = data.roomId;
      }
      var str = $('#room-tpl').html().replace(/@roomId@/g,data.roomId);
      $('#allroom').append(str);
      //查询当前群组内的 成员
      var AVOSRealtimeGroups = AV.Object.extend("AVOSRealtimeGroups");
      var query = new AV.Query(AVOSRealtimeGroups);
      query.get(data.roomId, {
        success: function(obj) {
          var members = obj.get('m');
          members.forEach(function(id){
            if(id!=peerId){
              $('#room-container-'+data.roomId+ ' .members').append($('#room-member-tpl').html().replace(/@peerId@/g,id));
            }
          });
        },
        error: function(object, error) {
          // The object was not retrieved successfully.
          // error is a AV.Error with an error code and description.
        }
      });
    });
    chat.on('left', function(data){
      $('#room-container-'+data.roomId).remove();
    });
    chat.on('membersLeft',function(data){
      if(data.peerId == peerId){

      }
      data.roomPeerIds.forEach(function(id){
        $('#room-member-'+id).remove();
      });

    })
  });

  $('#open').click(function(){
    $('#allwatcher').empty();

    addWatchingPeer($('#watchingPeer').val().split(','));
    chat.open().then(function(){
      $('#status').append('Opened');
      $('#status').append('<br>');
      $('#connect-status').text('connected')
    },function(err){
      alert('open failure');
      console.log(err)
    });
  });

  $('#close').click(function(){
    chat.close().then(function(){
      $('#connect-status').text('not connected');
      $('.online').removeClass('online').addClass('offline');
    });
  })

  //---------------- 1 v 1 聊天相关 ----------------


  $('#addwatch').click(function(){
    addWatchingPeer($('#watchingPeer').val().split(','));
    chat.watch($('#watchingPeer').val().split(',')).then(function(){

    },function(){
      alert('watch failure')
    });
  });

  $('#removewatch').click(function(){
    removeWatchingPeer($('#watchingPeer').val().split(','));
    chat.unwatch($('#watchingPeer').val().split(','));
  });

  function setSendTo(peerId){
    toPeerId = peerId;
    $('#to-peer-id').text(toPeerId);
  }
  function addWatchingPeer(peers){
    for(var i=0;i<peers.length;i++){
      if(!peers[i]){
        return;
      }
      var str = $('#watcher-tpl').html().replace(/@peerId@/g,peers[i]);
      $('#allwatcher').append(str);
    }
  }

  function removeWatchingPeer(peers){
    peers = [].concat(peers);
    for(var i=0;i<peers.length;i++){
      if(!peers[i]){
        return;
      }
      $('#peer-'+peers[i]).remove();
    }
  }

  $('#sendbtn').click(function(){
    chat.send($('#msg').val(),toPeerId).then(function(){
      $('#msgsent').append(JSON.stringify({
        msg: $('#msg').val(),
        toPeerId: toPeerId
      }));
      $('#msgsent').append('<br>');
      $('#msg').val('');
      // $('#status').append('Msg Sended');
      // $('#status').append('<br>');
    },function(){
      alert("send failure!!!")
    });
  });

  //------------- room 相关 ----------------

  var roomId ;
  function setRoom(roomId){
    $('#roomid').val(roomId);
  }
  function setCurrentRoom(roomid){
    roomId = roomid;
  }
  $('#joinroom').click(function(){
    chat.joinRoom($('#roomid').val()).then(function(data){

      // console.log(data)
      // $('#roomid').val(data.roomId);
      // alert('joined')
    })
  });
  $(document).on('click','.leave', function(){
    // var roomId = $(this).parents('.room').data('room-id');
    chat.leaveRoom(roomId).then(function(data){
      console.log(data)

      // alert('joined')
    })
  });
  $('#inviteroom').click(function(){
    chat.inviteToRoom(roomId,$('#inviteroomtxt').val().split(',')).then(function(data){

      // alert('joined')
    })
  });
  $(document).on('click','.kick', function(){
    var roomId = $(this).parents('.room').data('room-id');
    var targetId = $(this).parents('.room-member').data('room-member-id');
    chat.kickFromRoom(roomId,targetId).then(function(data){
      console.log(data)
      // $('#roomid').val(data.roomId);
      // alert('joined')
    })
  });

  $('#sendroom').click(function(){
    chat.sendToRoom($('#msgroom').val(),roomId).then(function(){
      $('#msgsent').append(JSON.stringify({
        msg: $('#msgroom').val(),
        roomId: roomId
      }));
      $('#msgsent').append('<br>');
      $('#msgroom').val('');
      // $('#status').append('Msg Sended');
      // $('#status').append('<br>');
    },function(){
      alert("send failure!!!")
    });
  });

  $('#getstatus').click(function(){
    chat.getStatus($('#querypeer').val().split(',')).then(function(data){
      console.log(data);
      $('#peeronline').text(data.onlineSessionPeerIds.join(','));
    })
  });


  //认证
  function auth(peerId,watchingPeers){
    return new Promise(function(resolve,reject){
      $.post('http://localhost:8080/sign',{
        self_id : peerId,
        watch_ids: watchingPeers.join(':')
      }).success(function(data){
        console.log(data.watch_ids)
         resolve({
          n: data.nonce,
          t: data.timestamp,
          s: data.signature,
          watchingPeer: data.watch_ids.split(':')
         });
      }).error(function(err){
        reject(err);
      })
    })

  }
</script>
</body>
</html>